@using System.Globalization;
@{
    ViewData["Title"] = "Home Page";
}
@using System.Text.Encodings.Web
@using System.Text.Json
@{
    var jsonOptions = new JsonSerializerOptions
    {
        Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    };

    var monthlyJson = JsonSerializer.Serialize(Model.IncomeExpenseLast12Months, jsonOptions);
    var categoryJson = JsonSerializer.Serialize(Model.ExpenseByCategoryThisMonth, jsonOptions);
}


<h1 class="h5 mb-3">
    <i class="bi bi-bar-chart-steps"></i>
    Overview – @DateTime.Now.ToString("MMMM yyyy", new CultureInfo("en-UK"))
</h1>
<!-- Cards with overview items for current month -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body rounded-4 shadow-sm">
                <div class="text-muted"><i class="bi bi-bank"></i> Balance</div>
                <div class="fs-4 fw-semibold @(Model.BalanceThisMonth < 0 ? "text-danger" : "text-success")">
                    @Model.BalanceThisMonth.ToString("F1") <span class="text-muted fs-6">CZK</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body rounded-4 shadow-sm">
                <div class="text-muted"><i class="bi bi-graph-up-arrow"></i> Total income</div>
                <div class="fs-4 fw-semibold text-success">
                    @Model.TotalIncomeThisMonth.ToString("F1") <span class="text-muted fs-6">CZK</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body rounded-4 shadow-sm">
                <div class="text-muted"><i class="bi bi-graph-down-arrow"></i> Total expense</div>
                <div class="fs-4 fw-semibold text-danger">
                    @Model.TotalExpenseThisMonth.ToString("F1") <span class="text-muted fs-6">CZK</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body rounded-4 shadow-sm">
                <div class="text-muted"><i class="bi bi-trophy"></i> Top category</div>
                <div class="fs-5 fw-semibold">
                    @Model.TopCategoryThisMonth
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
@if (Model.Last5Transactions != null && Model.Last5Transactions.Count > 0)
{
    <div id="dashboardCharts"
         data-monthly='@Html.Raw(monthlyJson)'
         data-categories='@Html.Raw(categoryJson)'>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-lg-6 col-md-6 ">
            <div class="card p-2 rounded-4 shadow-sm">
                <div class="card-body p-2">
                    <h5>Last 12 months</h5>
                    <canvas id="incomeExpenseChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-4">
            <div class="card p-2 rounded-4 shadow-sm">
                <div class="card-body p-2">
                    <h5>@DateTime.Now.ToString("MMMM", new CultureInfo("en-UK"))</h5>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-info mt-3">
        No data yet. Add your first transaction to see charts.
    </div>
}

<!-- Table with last 5 transactions -->
<div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="h5 mb-0"><i class="bi bi-dice-5"></i> Last 5 transactions</h2>
    <a class="btn btn-sm btn-outline-secondary" asp-controller="Transactions" asp-action="Index">View all</a>
</div>

@if (Model.Last5Transactions == null || Model.Last5Transactions.Count == 0)
{
    <div class="card">
        <div class="alert alert-info">
            No transactions yet. Add your first one in <a asp-controller="Transactions" asp-action="Create">Transactions</a>.
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-body p-2 rounded-4 shadow-sm">
            <table class="table table-striped table-hover align-middle table-sm fs-6">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var t in Model.Last5Transactions)
                    {
                        <tr>
                            <td>@t.Date.ToString("dd.MM.yyyy")</td>
                            <td>@t.Type</td>
                            <td>@(t.Category?.Name ?? "-")</td>
                            <td class="text-end">@t.Amount.ToString("F1")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/dashboard-charts.js" asp-append-version="true"></script>
}